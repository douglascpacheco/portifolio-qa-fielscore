name: Autenticação Torcedor API Test

on:
  workflow_dispatch:

jobs:
  tests:
    runs-on: ubuntu-latest

    env:
      BASE_URL: 'http://localhost:3000'

    steps:
      - name: Checkout do Repositório
        uses: actions/checkout@v4

      - name: Instalando dependências
        run: npm install

      - name: Iniciando servidor da API
        run: |
          npm start &
          echo "Aguardando API responder..."
          
          # tenta por até 30 segundos
          for i in {1..30}; do
            if curl -s http://localhost:3000 > /dev/null; then
              echo "✅ API está no ar!"
              break
            fi
            echo "⏳ Aguardando..."
            sleep 1
          done

      - name: Executar testes com Mocha + Mochawesome
        run: npx mocha ./test/torcedor.test.js

      - name: Upload do Relatório Mochawesome
        uses: actions/upload-artifact@v4
        with:
          name: mochawesome-report
          path: mochawesome-report/
